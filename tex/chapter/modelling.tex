\chapter{Modelling VRP in Constraint Programming}
\section{Input Data and any Potential Data Processing}
Let N the number of customers, input data are as follow:
\begin{enumerate}
    \item \begin{math}locX_{i}\end{math} for each i in \{1..N+1\} with a float domain defines the coordinate X of a location \begin{math}L_{i}\end{math}, the last one is a reference of the depot coordinate 
    \item \begin{math}locY_{i}\end{math} for each i in \{1..N+1\} with a float domain defines the coordinate Y of a location, the last one is a reference of the depot coordinate
    \item a list \begin{math}DEM\end{math} with \begin{math}de_{i} \in DEM, i \in \{1..N\}\end{math} and an integer domain; the demand of the customer i
    \item V is the number of vehicles available
    \item a list \begin{math}C\end{math} with \begin{math} c_{i} \in C, i \in \{1..V\}]\end{math} and an integer domain; the capacity of the vehicle i
\end{enumerate}
To solve the problem, each location needs to be visited. Therefore, it's important to take trace of visits in the routes of a solution. Each node represents a visit checked by only one vehicle. 
From the initial set of input data and observations taken from the problem, it's necessary to define the following processing data, useful to establish constraints in the model or to clarify some types of values:
\begin{enumerate}
 \setcounter{enumi}{5}
    \item \begin{math}NumVisits\end{math} is the total number of visits of the final combined route. It is equal to \begin{math}N + V * 2\end{math}
    \item a list \begin{math}D \end{math} with \begin{math}d_{i,j} \in D\end{math}, \begin{math}i,j \in \{1...(N+V*2)\}\end{math} and an integer domain; represents distances between two nodes i and j. Values are calculated as follow:\newline
    \begin{enumerate}
        \item\begin{math}\forall i,j \in \{1,...,N\}: d_{ij} = \sqrt{(locX_{j} - locX_{i})^2 + (locY_{j} - locY_{i})^2} * 1000\end{math}
        \item\begin{math}\forall i \in \{1,...,N\}, j \in \{N + 1,...,  N + V * 2\}:\newline d_{ij} = \sqrt{(locX_{N+1} - locX_{i})^2 + (locY_{N+1} - locY_{i})^2} * 1000\end{math}
        \item \begin{math}\forall i,j \in \{N + 1,...,  N + V * 2\}: d_{i,j} = 0\end{math}
    \end{enumerate}
    \item A weight of vehicle \begin{math}w\end{math} with integer domain represents the relevance of  minimizing the number of vehicles compared to the minimal distance traveled during the optimal research. 
\end{enumerate}
\section{Decision Variables}
A solution of the problem is made up of routes, one route for vehicles. It is a sequence of nodes (visits) formed by customers nodes (visited in the route) and 2 depot visits (one start and one end node).

\begin{figure}[h]
    \centering
    \includegraphics[width=0.5\textwidth]{images/combined-route-solution.png}
    \caption{A solution of VRP with 5 customers and 2 vehicles with 2 routes. Nodes \{6,7\} are start visits nodes and \{9,8\}are end visits.}
    \label{fig:mesh1}
\end{figure}

Starting from these observations, the model has the following decision variables:
\begin{enumerate}
    \item list of vehicles assignments \begin{math}VEH, ve_{i} \in VEH, i \in \{1...NumVisits\}\end{math} with domains \begin{math}\{1,...,V\}\end{math}where for each \begin{math}i \in \{1,..., NumVisits\}, j \in {1,...,V} ,\end{math}if \begin{math} ve_{i} = j\end{math} then the node i is visited by the vehicle j
    \item list of successions \begin{math}S, s_{i} \in S, i \in \{1...NumVisits\}\end{math} with domains \begin{math}\{1,..., NumVisits\}\end{math} where for each \begin{math}i,j \in \{1,..., NumVisits\}\end{math} if \begin{math}succ[i] = j\end{math} then the successor of node i is j in the combined route environment. 
    \item list of values \begin{math}U, u_{i} \in U, i \in \{1...V\}\end{math} with domain \begin{math}\{0,1\}\end{math} where for each \begin{math}i \in \{1,...,V\}\end{math} if \begin{math}u_{i} = 1 \end{math} then the vehicle visits at least one customer node, \begin{math} u_{i} = 0\end{math} otherwise
\end{enumerate}
\newpage
\section{Problem \& Additional Constraints}
\subsection{Main Constraints}
As stated in paragraph 1.1, the Vehicle Routing Problem is seen as the combination of Travelling Salesman Problem (TSP) and Knapsack Problem. Therefore, VRP can inherit some TSP and Knapsack Problem constraints.
\newline
\newline
Using TSP definition, we can assume these following adaptive constraints for VRP model:
\begin{enumerate}
    \item \begin{math}circuit([s_{1},...,s_{NumVisits}])\end{math} constraints the elements of the list \begin{math}s\end{math} to define the \textit{Hamiltonian path} where \begin{math}\forall i \in \{1,...,NumVisits\},s_{i} = j, j \in \{1,., i-1,i+1,..,NumVisits\}\end{math} means that j is the successor of i.
\end{enumerate}
Using Knapsack Problem definition, we can add these following constraints for the \begin{math}[c_{1}, ..., c_{v}]\end{math} capacities and \begin{math}[de_{1}, ..., de_{N}]\end{math} customers demands:

\begin{enumerate}
 \setcounter{enumi}{1}
    \item \begin{math} \forall v \in \{1,..., V\}, \:\sum_{i \in \{1,..,N\} : ve_{i} = v}de_{i} \leq c_{v}, \end{math}
\end{enumerate}

To maintain consistency with the problem definition, are defined a series of constraints to start and end every vehicles routes at the depot and linking constraints to manage the start and end nodes.\newline
Linking and consistency constraints are as follow:
\begin{enumerate}
 \setcounter{enumi}{2}
    \item \begin{math}\forall s \in \{N+1, ..., N + V\},\: ve_{s} = s - N\end{math}
    \item \begin{math}\forall e \in \{N + V + 1, ..., N + V * 2\}, \:ve_{e} = e - N - V\end{math}
    \item \begin{math}\forall i \in \{N + V + 1,...N + (V * 2) - 1\}, \:s_{s_{i}} = s_{i} - V + 1 \end{math}
    \item \begin{math}s_{N + 2 * V} = N + 1\end{math}
    \item \begin{math}\forall j \in \{1,..., N\}, \:ve_{s_{j}} = ve_{j}\end{math}
    \item \begin{math}\forall i \in \{1,...,N\},\:u_{ve_{i}} = 1 \end{math}
\end{enumerate}
\subsection{Additional Constraints}
VRP additional constraints are used to increase the optimal solution with the reduction of the search space using symmetry breaking constraints or implied constraints. It is important to note that some breaking constraints caused a drop in search performance, so they were not considered within the final model.

\begin{enumerate}
 \setcounter{enumi}{8}
    \item \begin{math}alldifferent([s_{1},...,s_{NumVisits}])\end{math} successor implied constraint
    \item \begin{math}\forall i,j \in \{1,...,V\} \: \land c_{i} = c_{j} \land i < j,\: u_{j} > 0 \Rightarrow u_{i} > 0\end{math} breaks same-capacity vehicles symmetry
\end{enumerate}
\newpage
\section{Objective Function}
Let \begin{math}w\end{math} the weight of vehicles and let \begin{math} td\end{math} and \begin{math}vu\end{math} respectively the total distance traveled by vehicles and the number of vehicles used defined as follow: 
\begin{itemize}
    \item \begin{math}td = \sum_{v \in \{1,...,NumVisits\}}d_{v, s_{v}}\end{math}
    \item \begin{math}vu = \sum_{v \in \{1,...,V\}}u_{v}\end{math}
\end{itemize}
The objective function is:
\begin{center}
    \begin{math}f(td,vu) = td + (vu * w)\end{math}
\end{center}
The objective of the problem is:
\begin{center}
    \begin{math}min(f(td,vu))\end{math}
\end{center}
The value of w is the balance value of the reduction of vehicles number compared to the reduction of the total distance.The more the value of \begin{math}w\end{math} is huge and more the objective function tends to optimize the minimum values of vehicles than the total distances.

